<!DOCTYPE html>
<html>
<head>
<title>fits reader</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src='fits.js'></script>
<style>
#tabbar {
  display: flex;
  flex-wrap: wrap;
}

#tabbar input {
  display: none;
}

#tabbar input + label {
  flex: 1;
  background: #ccc;
  padding: 3px 5px;
  border: 1px solid white;
  border-bottom: 1px solid;
}

#tabbar input:checked + label {
  background: #f9f9f9;
  border: 1px solid;
  border-bottom: none;
  padding: 0px 5px;
  pointer-events: none;
}

#tabbar input:checked + label > span:first-child {
  font-weight: bold;
}

ol {
  width: 80ch;
  font-family: monospace;
  font-size: 12px;
  background: #f9f9f9;
  white-space: pre;
  margin-top: 0px;
  border: 1px solid;
  border-top: none;
  display: none;
}

li::marker {
  color: grey;
  font-size: 10px;
}

li > span {
 color: #00c;
}

/* remove dot/full stop/period */
ol {
  counter-reset: item;
  padding: 2px;
  margin-left: 40px;
}

li {
  counter-increment: item;
}

li::marker {
   content: counter(item)"  ";
}

[for="tab_0"] {
  margin-left: 40px;
}

.fa-github, .fa-share-alt {
  float: right;
}

.fa-bars {
  rotate: 90deg;
}

[class*=" fa-"] {
  color: black;
  padding: 0px 4px;
}

#func::placeholder {
  color: grey;
}

#unselect {
   display: none;
}

#unchecked:not(:checked) ~ #fitshdulist > #tabbar > ol {
  height: 0px;
  overflow: hidden;
  padding-top: 0px;
  padding-bottom: 0px
}

#fitsdisplay {
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
    outline: 1px solid #080;  /* border complicates transforms, also 1px yields 0.666 px */
    transform-origin: 0 0;
}

#x, #y {
  width: 10ch;
}

</style>
<style>
/* dynamically filled via js */
</style>

</head>

<h1 style="text-align: center">Fits viewer</h1>

<label>file:</label> <label for="fileInput" class="input" style="display: inline-block;  text-align: left">Choose file</label> <input id="fileInput" type="file" style="display:none" onchange="this.previousElementSibling.textContent = this.previousElementSibling.title = this.files[0].name; doit(this.files[0])"><button onclick="this.previousElementSibling.click()">Browse...</button>
<a href="https://github.com/mzechmeister/fits"><i class="fab fa-github"></i></a> <a href="" id ="share"><i class="fa fa-share-alt" draggable="true"></i></a><br>
<label>url:</label> <input type="url" id="url" class="input" value="a.fits" onkeyup="if (event.key === 'Enter') doit(this.value)"><input type="submit" value="Load" onclick="doit(url.value)"> <span id="info"></span><br>
colfunc: <input id="func" placeholder="x">
<label>color map:</label> <select id="colormap" onchange="display(d)">
<option>grey</option>
<option>bb</option>
<option></option>
</select>
x: <input id="x" onkeyup="if (event.key === 'Enter') panTo()"> y: <input id="y" onkeyup="if (event.key === 'Enter') panTo()"><span id="coords"></span> <input type="button" value="center" onclick="panTo(fitsdisplay.width/2+0.5, fitsdisplay.height/2+0.5) ">
<br>

<div style="display: inline-block; width: min-content;" id="fitshdulist">
<input type="radio" name="exttab" id="unselect"><label id="tabbar" for="unselect"></label>
</div>
zoom: <input id="zoomfac" style="width: 7ch" onchange="zoom.value=Math.log2(zoomfac.value) ; zoom.oninput()"> <input type="range" id="zoom" min="-6" max="6" step="0.5">
<input id="sharp" type="checkbox"><label for="sharp">sharp</label>
<br>
<div style="width: 100%; overflow: scroll; resize: both; height: 400px; border: 1px solid red" tabindex="0"><canvas id='fitsdisplay' height="0" style="transform: scale(1, -1)"></canvas></div>

<script>

async function doit(filename) {
    hdulist = await readfits(filename)
    tabbar.innerHTML = '<ol id="dummywidth" style="display: block; height: 0px; overflow: hidden; visibility: hidden; margin-bottom: 0px;"><li>'+" ".padEnd(80) +'</ol>'
    tabbingstyle = document.getElementsByTagName('style')[1]
    tabbingstyle.innerHTML = ''
    for (hdu of hdulist) {
        // make tabs
        k = hdu.extnum
        var extname = hdu.hdr["EXTNAME"] || ''
        extname &&= ' ['+extname.trim()+']'
        var but = hdu.dim.length ? ' <button onclick="show('+k+'); return false">'+ (hdu.cols?'<i class="fas fa-bars"></i>':'<i class="fas fa-image"></i>') + hdu.dim.join('<span style="padding: 1px;">&times;</span>') + '</button>' : ''
        tabbar.innerHTML += '<input type="radio" name="exttab" id="tab_'+k+'"><label for="tab_'+k+'"><span>'+k+extname+'</span>:' +  but + '</label>'
    }
    for (hdu of hdulist) {
        // append headers
        tabbar.innerHTML += '<ol id="fitshdu_'+hdu.extnum+'"><li>'+hdu.cards.join("\n<li>")+'</ol>'
        tabbingstyle.innerHTML += '#tab_'+hdu.extnum+':checked ~ #fitshdu_'+hdu.extnum+' {display: unset;}\n'
    }
    // color the first 8-char word
    document.querySelectorAll("li").forEach(x => (x.innerHTML = '<span>'+x.innerText.slice(0,8)+'</span>'+x.innerText.slice(8)))
}

// colormaps
// https://github.com/matplotlib/matplotlib/blob/9f96205464930c9064eb20af462c79ac47c6b254/lib/matplotlib/_cm.py#L158
cmbb = x => [2 * x, 2 * x - 0.5, 2 * x - 1]  // ds9bb, afmhot
cmgrey = x => [x, x, x]

function display(a) {
    if (!a) {console.log('No data to display.'); return}
    _func = new Function("x", "return " + (func.value || func.placeholder))

    var canvas = fitsdisplay;
    var ctx = canvas.getContext("2d");

    [canvas.width, canvas.height] = a.dim;

    // get the imageData and pixel array from the canvas
    var imgData = ctx.getImageData(0,0, ...a.dim);
    var data = imgData.data;

    cm = {bb: cmbb, grey: cmgrey}[colormap.value] || cmgrey
    // put rgba values
    for (var i=0, j=0; i<data.length; i+=4, ++j) {
        [data[i], data[i+1], data[i+2]] = cm(_func(a[j])).map(x => 0xFF * x);
        data[i+3] = 0xFF;   // opacity
    }

    //ctx.scale(1, -1)
    ctx.imageSmoothingEnabled = false
    ctx.putImageData(imgData, 0, 0);
    do_zoom()
}

function nanMinMax(x) {
   var u = x.filter(xi => !Number.isNaN(xi));
   return [Math.min(...u), Math.max(...u)]
}

show = async (ext) => {
    await fitsdata(hdulist, ext);
    d.ext = ext;
    [d.min, d.max] = nanMinMax(d);
    func.placeholder  = '(x-('+d.min+')) / ' + (d.max-d.min);
    display(d)
}

// create shared link
document.getElementById("share").onclick = function(e) {
    e.preventDefault()
    _url = new URL(window.location)
    _url = _url.origin + _url.pathname
    args = [url, func, zoom, colormap].filter(x => x.value).map(x => x.id+"="+x.value)
    ext = document.querySelector("[id^=tab_]:checked")
    if (ext) args.push("ext="+ext.id.slice(4))
    if (d) args.push("disp="+d.ext)
    var link = document.createElement("a")
    link.href = _url + "?" + args.join("&")
    link.append(link.href)
    info.innerHTML = link.outerHTML
}


function getMousePos(e) {
    return get_ij(e.clientX, e.clientY)
}

function get_ij(X, Y) {
    // get image coords from page coords
    var rect = fitsdisplay.getBoundingClientRect();
    var p = {x: X - rect.left,
             y: -(Y - rect.bottom)}
    p.i = p.x / scale + 0.5   // one based and integer in center
    p.j = p.y / scale + 0.5
    return p
}

function get_icjc() {
    // get image coords at center of view
    Xc = fitsdisplay.parentElement.offsetLeft + fitsdisplay.parentElement.clientWidth / 2 + 1.5
    Yc = fitsdisplay.parentElement.offsetTop + fitsdisplay.parentElement.clientHeight / 2 + 0.5 - window.scrollY
    return get_ij(Xc, Yc)
}

function z(i, j) {
    var zij = d[Math.round(i-1) + fitsdisplay.width * Math.round(j-1)]
    return zij == undefined ? NaN : zij
}

fitsdisplay.onclick = e => {
    p = getMousePos(e);
    x.value = p.i.toFixed(3)   // one based indexing
    y.value = p.j.toFixed(3)
    coords.innerHTML = " value: "+ z(p.i,p.j)+ " color: "+ _func(z(p.i,p.j)).toFixed(6)
}

fitsdisplay.onmousemove = e => {
    p = getMousePos(e);
    info.innerHTML = " x: "+p.i.toFixed(3)+" y: "+p.j.toFixed(3) +" value: "+ z(p.i,p.j)+ " color: "+ _func(z(p.i,p.j)).toFixed(6)
}

func.onchange = e => {display(d)}

document.body.onkeydown = e => {
    if (e.key == "+") {++zoom.value; display(d)}
    else if (e.key == "-") {--zoom.value; display(d)}
}


scale = null

function panTo(i=null, j=null) {
    if (i===null) {
        i = document.getElementById('x').value
        j = document.getElementById('y').value
    }
    scrollBarWidth = fitsdisplay.parentElement.offsetWidth - fitsdisplay.parentElement.clientWidth;
    vp = fitsdisplay.parentElement.getBoundingClientRect()  // "viewport"
    wp = vp.width - scrollBarWidth
    hp = vp.height - scrollBarWidth
    var x = padx - wp/2 + (i-0.5)*scale
    var y = pady + fitsdisplay.height*scale - hp/2 - (j-0.5)*scale
    fitsdisplay.parentElement.scrollTo(x, y)
}

function do_zoom(){
    // zoom to center as fallback
    pc = scale == null ?  {i: fitsdisplay.width/2+0.5, j: fitsdisplay.height/2+0.5} : get_icjc()
    scale = 2**zoom.value
    zoomfac.value = scale < 1 ? '1/'+(+(1/scale).toFixed(3)) : +scale.toFixed(3)

    scrollBarWidth = fitsdisplay.parentElement.offsetWidth - fitsdisplay.parentElement.clientWidth;
    vp = fitsdisplay.parentElement.getBoundingClientRect()  // "viewport"
    hp = vp.height - scrollBarWidth
    wp = vp.width - scrollBarWidth
    fitsdisplay.style["margin"] = sharp.checked ? '' : hp+'px '+(wp+fitsdisplay.width*scale-fitsdisplay.width+1)+'px '+(hp+fitsdisplay.height*scale-fitsdisplay.height-1)+'px '+ wp+'px'

    fitsdisplay.style.transform = "scale("+scale+",-"+scale+") translate(0,-100%)"
    padx = (fitsdisplay.width - fitsdisplay.width*scale) / 2
    padx = Math.max(0, padx, (wp - fitsdisplay.width*scale)/2)
    pady = (fitsdisplay.height - fitsdisplay.height*scale) / 2
    pady = Math.max(0, pady, (hp - fitsdisplay.height*scale)/2)
    if (sharp.checked && (padx || pady))
        fitsdisplay.style.transform = "translate("+padx+"px,"+pady+"px)" + fitsdisplay.style.transform

    if (!sharp.checked) pady = hp
    if (!sharp.checked) padx = wp

    panTo(pc.i, pc.j)
}

zoom.oninput = do_zoom

url_kwargs = Object.fromEntries(new URL(window.location).searchParams)

for (var key in url_kwargs) {
    elem = document.querySelector("#"+key)
    if (elem) {
        if (elem.type == "checkbox") elem.checked = +url_kwargs[key]
        else elem.value = url_kwargs[key]
    }
}

doit(url.value).then(async e => {
   if (ext=url_kwargs['ext']) document.querySelector("#tab_"+ext).click()
   if (disp=url_kwargs['disp']) {
      show(disp)
   }
})

</script>

</html>
