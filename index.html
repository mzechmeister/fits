<!DOCTYPE html>
<html>
<head>
<title>fits reader</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src='fits.js'></script>

<style>
body {
  font-size: smaller;
}

ol {
  width: 80ch;
  font-family: monospace;
  font-size: 12px;
  background: #f9f9f9;
  white-space: pre;
  margin-top: 0px;
  border: 1px solid;
}

li::marker {
  color: grey;
  font-size: 10px;
}

li > span {
 color: #00c;
}

/* remove dot/full stop/period */
ol {
  counter-reset: item;
  padding: 2px;
  margin-left: 40px;
}

li {
  counter-increment: item;
}

li::marker {
   content: counter(item)"  ";
}

.fa-github, .fa-share-alt {
  float: right;
}

#hduinfo i {
  width: 16px;
  padding: 0;
}

[class*=" fa-"] {
  color: black;
  padding: 0px 4px;
  text-align: center;
}

#func::placeholder {
  color: grey;
}


#fitsdisplay {
    image-rendering: optimizeSpeed;
    image-rendering: -moz-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: optimize-contrast;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
    outline: 1px solid #080;  /* border complicates transforms, also 1px yields 0.666 px */
    transform-origin: 0 0;
}

#x, #y {
  width: 10ch;
}

.colname {
  background: lightgrey;
  padding: 0px 2px;
}

.resizeable_iframe {
  resize: both;
  overflow: hidden;
  border: 1px green solid;
}

#fitsgraph {
  border: none;
}

details {
  clear: both;   /* float button the very end in every row */
}

#hduinfo summary:hover {
  background: #eef;
}

#hduinfo button {
  float: right;
  font-size: smaller;
  padding: 0px 1ch;
}

.loading::before {
  content: 'Reading ';
}
.loading {
  color: blue;
}

.loading::after {
  animation: dotty 1s steps(1) infinite;
  content: ' ...';
}

@keyframes dotty {
  0%   { content: ''; }
  25%  { content: ' .'; }
  50%  { content: ' ..'; }
  75%  { content: ' ...'; }
}

.error {
  color: red;
}

.slider input {
  --start: 1%;
  --stop: 99%;
  -webkit-appearance: none;
  appearance: none;
  background: none;
  pointer-events: none;
  position: absolute;
  height: 6px;
  border-radius: 6px;
}

.slider input:first-of-type {
  background-image: linear-gradient(to right, lightgrey var(--start), dodgerblue var(--start), dodgerblue var(--stop), lightgrey var(--stop));
}

.slider ::-moz-range-thumb {
  cursor: pointer;
  pointer-events: auto;
}
.slider ::-webkit-slider-thumb {
  cursor: pointer;
  pointer-events: auto;
}

#modebar {
  float: right;
}

#modebar label {
  border-radius: 4px;
  color: red;
  padding: 8px;
  width: 1.25em;
}

#modebar label:hover {
  background: #ddd7;
}

#modebar label:active {
  background: #7775;
}

#fullscreen {
  display: none;
}

#fullscreen:checked + #modebar {
  position: fixed;
  top: 0.5em;
  z-index: 99;
  right: 2em;
}

#fullscreen:checked ~ div {
  background: white;
  bottom: 0;
  height: auto !important;
  left: 0;
  position: fixed;
  top: 0;
}

#val_pmax, #val_pmin, #val_zmax, #val_zmin {
  direction: rtl;   /* spinner left */
  width: 10ch;
}

#val_pmax, #val_pmin {
  margin-right: -2ch;  /* percentage unit */
  padding: 0 2ch 0 0;
  width: 6ch;
}

input[type="number"] {
  text-align: right;
}

#val_pmin + span {
  width: 2ch;
  display: inline-block;
  text-align: left;
}

th {
    font-weight: normal;
}

</style>

</head>

<h1 style="text-align: center">Fits viewer</h1>

<label>file:</label> <label for="fileInput" class="input" style="display: inline-block;  text-align: left">Choose file</label> <input id="fileInput" type="file" style="display:none" onchange="this.previousElementSibling.textContent = this.previousElementSibling.title = this.files[0].name; doit(this.files[0])"><button onclick="this.previousElementSibling.click()">Browse...</button>
<a href="https://github.com/mzechmeister/fits"><i class="fab fa-github"></i></a> <a href="" id ="share"><i class="fa fa-share-alt" draggable="true"></i></a><br>
<label>url:</label> <input type="url" id="url" class="input" value="a.fits" onkeyup="if (event.key === 'Enter') doit(this.value)"><input type="submit" value="Load" onclick="doit(url.value)">

<br><span id="fileinfo"></span> <span id="info"></span><br>
<div id="hduinfo"></div>

<details id="plotcontainer">
<summary>plot</summary>
<div class="resizeable_iframe" style="height: 400px; clear: both;">
<iframe id="fitsgraph" width="100%" height="100%" style="resize: both;"></iframe>
</div>
</details>

<details id="dispcontainer">
<summary>display</summary>

<table style="text-align: left;display: inline-block;">
  <tr>
    <th>colfunc: <input id="func" placeholder="x">
    <th style="text-align: right"><input type="number" id="val_pmin" title="lower percentile"><span>%</span>
    <th><span class="slider" style="width: 200px; display: inline-block; transform: translate(0px, -10px);">
        <input type="range" id="rng_pmin" title="lower percentile">
        <input type="range" id="rng_pmax" title="upper percentile">
      </span>
    <th><input type="number" id="val_pmax" title="upper percentile">%
  </tr>
  <tr>
  <th><label>color map:</label> <select id="colormap" onchange="display(dispdata)">
<option></option>
<option>grey</option>
<option>bb</option>
</select>
  <th style="text-align: right"><input type="number" id="val_zmin" title="lower percentile">
  <th>
  <th><input type="number" id="val_zmax" title="upper percentile">
  </tr>
</table>

<br>
x: <input  id="x" type="number" onchange="panTo()"> y: <input id="y" type="number" onchange="panTo()"><span id="coords"></span> <input type="button" id="center" value="center" onclick="panTo(fitsdisplay.width/2+0.5, fitsdisplay.height/2+0.5) ">

zoom: <input id="zoomfac" style="width: 7ch" onchange="zoom.value=Math.log2(zoomfac.value) ; zoom.oninput()"> <input type="range" id="zoom" min="-6" max="6" step="0.5">
<input id="sharp" type="checkbox"><label for="sharp">sharp</label>
<input id="fullscreen" type="checkbox">
<span id="modebar">
<label class="fa fa-tint" onclick="(colormap.selectedOptions[0].nextElementSibling || colormap.options[1]).selected = true; colormap.onchange()"></label><label for="center" class="fas fa-bullseye"></label><label for="fullscreen" class="fas fa-expand"></label>
</span>
<br>
<span id="displayinfo"></span><br>
<div style="width: 100%; overflow: scroll; resize: both; height: 400px; border: 1px solid red" tabindex="0"><canvas id='fitsdisplay' height="0" style="transform: scale(1, -1)"></canvas></div>
</details>

<script>

function fitsplot(ext=0) {
    var url = hdulist[0].filename + "[" + ext + "]"
    plotcontainer.open = true
    plotcontainer.ext = ext
    fitsgraph.src = "csv_plotter.htm?url=" + url + "&cx=$0&cy=$1&title=" + obj
}

async function doit(filename) {
    fileinfo.innerHTML = filename
    fileinfo.className = 'loading'
    dispdata = null
    try {
       hdulist = await fitsopen(filename)
    } catch(e) {
       fileinfo.className = 'error'
       fileinfo.innerHTML = 'Error: Could not read ' + filename
       console.log(e)
       return
    }
    obj = hdulist[0].hdr['OBJECT']
    hduinfo.onclick = e => e.target.className!="colname"   // ignore colnames in clicks
    fileinfo.innerHTML = hdulist[0].filename + (obj? ' ['+obj+']': '')
    fileinfo.className = ''
    hduinfo.innerHTML = ''
    for (hdu of hdulist) {
        // make hduinfo
        k = hdu.extnum
        var extname = hdu.hdr["EXTNAME"] || '<i style="color: grey">PrimaryHDU</i>'
        extname = extname.trim()
        var icon = hdu.cols ? "fas fa-list" : hdu.dim.length ? "fas fa-image" : "fas fa-database"
        icon = `<i class="${icon}"></i>`
        var dim = hdu.dim.join('<span style="padding: 1px;">&times;</span>')
        if (dim) dim = ", " + dim
        var but = hdu.cols ? ['fitsplot('+k+')', 'plot'] : hdu.dim.length ? ['show('+k+')', 'display'] : ''
        if (but) but = ` <button onclick="${but[0]}; return false">${but[1]}</button>`
        var colnames = ''
        if (hdu.cols) for (col of hdu.cols) colnames += ' <span class="colname">'+col.name+'</span>'
        var summary = `${icon} ${k} [${extname}${dim}] ${colnames} ${but}`
        hduinfo.innerHTML += '<details id="tab_'+k+'"><summary>'+ summary + '</summary>' +
            ' <ol><li>'+hdu.cards.join("\n<li>")+'</ol>' +
            '</details>'
    }
    // color the first 8-char word
    document.querySelectorAll("li").forEach(x => (x.innerHTML = '<span>'+x.textContent.slice(0,8)+'</span>'+x.textContent.slice(8)))
}

// colormaps
// https://github.com/matplotlib/matplotlib/blob/9f96205464930c9064eb20af462c79ac47c6b254/lib/matplotlib/_cm.py#L158
cmbb = x => [2 * x, 2 * x - 0.5, 2 * x - 1]  // ds9bb, afmhot
cmgrey = x => [x, x, x]

function display(a) {
    if (!a) {console.log('No data to display.'); return}
    norm = new Function("z", `return (z-(${val_zmin.value})) / (${val_zmax.value}-(${val_zmin.value}))`)
    _func = new Function("z", "let x = norm(z); return " + (func.value || func.placeholder))

    var canvas = fitsdisplay;
    var ctx = canvas.getContext("2d");

    [canvas.width, canvas.height] = a.dim;

    // get the imageData and pixel array from the canvas
    var imgData = ctx.getImageData(0,0, ...a.dim);
    var data = imgData.data;

    cm = {bb: cmbb, grey: cmgrey}[colormap.value] || cmgrey
    // put rgba values
    for (var i=0, j=0; i<data.length; i+=4, ++j) {
        [data[i], data[i+1], data[i+2]] = cm(_func(a[j])).map(x => 0xFF * x);
        data[i+3] = 0xFF;   // opacity
    }

    //ctx.scale(1, -1)
    ctx.imageSmoothingEnabled = false
    ctx.putImageData(imgData, 0, 0);
    do_zoom()
}

function nanMinMax(x) {
   var u = x.filter(xi => !Number.isNaN(xi));
   var min = u.reduce((min, v) => min < v ? min : v)
   var max = u.reduce((max, v) => max >= v ? max : v)
   return [min, max]
}

show = async (ext) => {
    var d = await fitsdata(hdulist, ext);
    d.ext = ext;
    [d.min, d.max] = nanMinMax(d);
    val_pmin.value = rng_pmin.value = 1
    val_pmax.value = rng_pmax.value = 99
    cdf = d.filter(x => !isNaN(x)).sort((a, b) => a>b)
    percentile = p => cdf[Math.round((cdf.length-1)*p/100)]
    scale_update()
    dispdata = d
    display(dispdata)
    dispcontainer.open = true
}

// create shared link
document.getElementById("share").onclick = function(e) {
    e.preventDefault()
    _url = new URL(window.location)
    _url = _url.origin + _url.pathname
    args = [url, func, zoom, colormap].filter(x => x.value).map(x => x.id+"="+x.value)
    ext = hduinfo.querySelector("details[open]")
    if (ext) args.push("ext="+ext.id.slice(4))
    if (dispdata) args.push("disp="+dispdata.ext)
    if (plotcontainer.ext) args.push("plot="+plotcontainer.ext)
    var link = document.createElement("a")
    link.href = _url + "?" + args.join("&")
    link.append(link.href)
    info.innerHTML = link.outerHTML
}


function getMousePos(e) {
    return get_ij(e.clientX, e.clientY)
}

function get_ij(X, Y) {
    // get image coords from page coords
    var rect = fitsdisplay.getBoundingClientRect();
    var p = {x: X - rect.left,
             y: -(Y - rect.bottom)}
    p.i = p.x / scale + 0.5   // one based and integer in center
    p.j = p.y / scale + 0.5
    return p
}

function get_icjc() {
    // get image coords at center of view
    Xc = fitsdisplay.parentElement.offsetLeft + fitsdisplay.parentElement.clientWidth / 2 + 1.5
    Yc = fitsdisplay.parentElement.offsetTop + fitsdisplay.parentElement.clientHeight / 2 + 1.5 - window.scrollY
    return get_ij(Xc, Yc)
}

function z(i, j) {
    var zij = dispdata[Math.round(i-1) + fitsdisplay.width * Math.round(j-1)]
    return zij == undefined ? NaN : zij
}

fitsdisplay.onclick = e => {
    p = getMousePos(e);
    x.value = p.i.toFixed(3)   // one based indexing
    y.value = p.j.toFixed(3)
    coords.innerHTML = " value: "+ z(p.i,p.j)+ " color: "+ _func(z(p.i,p.j)).toFixed(6)
}

fitsdisplay.onmousemove = e => {
    p = getMousePos(e);
    displayinfo.innerHTML = " x: "+p.i.toFixed(3)+" y: "+p.j.toFixed(3) +" value: "+ z(p.i,p.j)+ " color: "+ _func(z(p.i,p.j)).toFixed(6)
}

func.onchange = e => {display(dispdata)}

document.body.onkeydown = e => {
    if (e.key == "+") {++zoom.value; display(dispdata)}
    else if (e.key == "-") {--zoom.value; display(dispdata)}
}


scale = null

function panTo(i=null, j=null) {
    if (i===null) {
        i = document.getElementById('x').value
        j = document.getElementById('y').value
    }
    scrollBarWidth = fitsdisplay.parentElement.offsetWidth - fitsdisplay.parentElement.clientWidth;
    vp = fitsdisplay.parentElement.getBoundingClientRect()  // "viewport"
    wp = vp.width - scrollBarWidth
    hp = vp.height - scrollBarWidth
    var x = padx - wp/2 + (i-0.5)*scale
    var y = pady + fitsdisplay.height*scale - hp/2 - (j-0.5)*scale
    fitsdisplay.parentElement.scrollTo(x, y)
}

function do_zoom(){
    // zoom to center as fallback
    pc = scale == null ?  {i: fitsdisplay.width/2+0.5, j: fitsdisplay.height/2+0.5} : get_icjc()
    scale = 2**zoom.value
    zoomfac.value = scale < 1 ? '1/'+(+(1/scale).toFixed(3)) : +scale.toFixed(3)

    scrollBarWidth = fitsdisplay.parentElement.offsetWidth - fitsdisplay.parentElement.clientWidth;
    vp = fitsdisplay.parentElement.getBoundingClientRect()  // "viewport"
    hp = vp.height - scrollBarWidth
    wp = vp.width - scrollBarWidth
    fitsdisplay.style["margin"] = sharp.checked ? '' : hp+'px '+(wp+fitsdisplay.width*scale-fitsdisplay.width+1)+'px '+(hp+fitsdisplay.height*scale-fitsdisplay.height-1)+'px '+ wp+'px'

    fitsdisplay.style.transform = "scale("+scale+",-"+scale+") translate(0,-100%)"
    padx = (fitsdisplay.width - fitsdisplay.width*scale) / 2
    padx = Math.max(0, padx, (wp - fitsdisplay.width*scale)/2)
    pady = (fitsdisplay.height - fitsdisplay.height*scale) / 2
    pady = Math.max(0, pady, (hp - fitsdisplay.height*scale)/2)
    if (sharp.checked && (padx || pady))
        fitsdisplay.style.transform = "translate("+padx+"px,"+pady+"px)" + fitsdisplay.style.transform

    if (!sharp.checked) pady = hp
    if (!sharp.checked) padx = wp

    panTo(pc.i, pc.j)
}

function sync(A, B) {
    A.addEventListener("input",  () => {B.value = A.value; scale_update();} )
    B.addEventListener("change", () => {A.value = B.value; scale_update();} )
}

sync(rng_pmin, val_pmin)
sync(rng_pmax, val_pmax)
zoom.oninput = do_zoom

scale_update = e => {
    rng_pmin.style.setProperty('--start', val_pmin.value + '%')
    rng_pmin.style.setProperty('--stop', val_pmax.value + '%')
    val_zmin.value = percentile(val_pmin.value)
    val_zmax.value = percentile(val_pmax.value)
    display(dispdata)
}

url_kwargs = Object.fromEntries(new URL(window.location).searchParams)

for (var key in url_kwargs) {
    elem = document.querySelector("#"+key)
    if (elem) {
        if (elem.type == "checkbox") elem.checked = +url_kwargs[key]
        else elem.value = url_kwargs[key]
    }
}

doit(url.value).then(async e => {
   if (ext=url_kwargs['ext']) document.querySelector("#tab_"+ext).open = true
   if (disp=url_kwargs['disp']) {
      show(disp)
   }
   if (plotext=url_kwargs['plot']) {
      fitsplot(plotext)
   }
})

</script>

</html>
