<!DOCTYPE html>
<html>
<head>
<title>fits reader</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
#tabbar {
  display: flex;
  flex-wrap: wrap;
}

#tabbar input {
  display: none;
}

#tabbar input + label {
  flex: 1;
  background: #ccc;
  padding: 3px 5px;
  border: 1px solid white;
  border-bottom: 1px solid;
}

#tabbar input:checked + label {
  background: #f9f9f9;
  border: 1px solid;
  border-bottom: none;
  padding: 0px 5px;
}

#tabbar input:checked + label > span:first-child {
  font-weight: bold;
}

ol {
  width: 80ch;
  font-family: monospace;
  font-size: 12px;
  background: #f9f9f9;
  white-space: pre;
  margin-top: 0px;
  border: 1px solid;
  border-top: none;
  display: none;
}

li::marker {
  color: grey;
  font-size: 10px;
}

li > span {
 color: #00c;
}

/* remove dot/full stop/period */
ol {
  counter-reset: item;
  padding: 2px;
  margin-left: 40px;
}

li {
  counter-increment: item;
}

li::marker {
   content: counter(item)"  ";
}

[for="tab_0"] {
  margin-left: 40px;
}

[class*=" fa-"] { 
  float: right;
  color: black;
  padding: 0px 4px;
}

#showhdr:not(:checked) ~ #fitshdulist > #tabbar > ol {
  height: 0px;
  overflow: hidden;
  padding-top: 0px;
  padding-bottom: 0px 
}

</style>
<style>
/* dynamically filled via js */
</style>

</head>

<h1 style="text-align: center">Fits explorer</h1>

<label>file:</label> <label for="fileInput" class="input" style="display: inline-block;  text-align: left">Choose file</label><input id="fileInput" type="file" style="display:none" onchange="this.previousElementSibling.textContent = this.previousElementSibling.title = this.files[0].name; doit(this.files[0])"><button onclick="this.previousElementSibling.click()">Browse...</button>
<a href="https://github.com/mzechmeister/fits"><i class="fab fa-github"></i></a> <a href="" id ="share"><i class="fa fa-share-alt" draggable="true"></i></a><br>
<label>url:</label> <input type="url" id="url" class="input" value="a.fits" onkeyup="if (event.key === 'Enter') doit(this.value)"><input type="submit" value="Load" onclick="doit(url.value)"><span id="info"></span><br>
<input id="func"><button id="disp">display</button>
<input id="showhdr" type="checkbox" checked><label>show header</label>
<br>

<div style="display: inline-block; width: min-content;" id="fitshdulist">
<div id="tabbar"></div>
</div>
<br>
<canvas id='fitsdisplay' height="0" style="transform: scale(1, -1)"></canvas>

<script>

async function gethdr(file, pos=0) {
    var hdu = {extstart: pos, file: file}
    var cards = []

    is_url = typeof file == "string"   // for url

    // read blockwise
    while (!cards.slice(-36).includes("END".padEnd(80, " "))) {
        if (is_url) {
            response = await fetch(file, {headers: {Range: `bytes=${pos}-${pos+2880-1}`}});
            if (!response.ok) return null;
        } else {
            response = file.slice(pos, pos+2880)  // exclusive
        }
        buf = await response.text()
        if (buf.length != 2880) return null;  // if range is ignored (e.g. python http.server)
        cards.push(...buf.match(/.{80}/g))
        pos += 2880
    }

    hdu.cards = cards
    hdu.ncards = cards.length
    hdu.hdr = hdr = cards2hdr(cards)
    hdu.bitpix = hdr['BITPIX']
    hdu.dim = [...Array(hdr.NAXIS).keys()].map(j => hdr['NAXIS'+(j+1)])
    hdu.datastart = pos
    hdu.hdrsize = hdu.datastart - hdu.extstart
    hdu.datasize = hdr.NAXIS && hdu.dim.reduce((a,b) => a*b, Math.abs(hdu.bitpix/8))
    padsize = Math.ceil(hdu.datasize/2880) * 2880
    hdu.dataend = hdu.datastart + hdu.datasize
    hdu.extend = hdu.datastart + padsize
    return hdu
}

function cards2hdr(cards) {
    hdr = {}
    for (card of cards) {
        [key, val, comm] = card.split(/[=/]/);
        if (val) {
            val = val.trim()
            val = val.startsWith("'") ? val.slice(1,-1) :
                  val == "T" ? true :
                  val == "F" ? false : +val;
            hdr[key.trim()] = val
        }
    }
    return hdr
}

async function readfits(file) {
    hdulist = []
    hdu = {extend: 0}
    while (hdu = await gethdr(file, hdu.extend)) {
        hdulist.push(hdu)
    }
    return hdulist
}

async function doit(filename) {
    hdulist = await readfits(filename)
    tabbar.innerHTML = ''
    tabbingstyle = document.getElementsByTagName('style')[1]
    tabbingstyle.innerHTML = ''
    for (k in hdulist) {
        var extname = hdulist[k].hdr["EXTNAME"] || ''
        extname &&= ' ['+extname.trim()+']'
        tabbar.innerHTML += '<input type="radio" name="exttab"'+ (k ? '':' checked')+' id="tab_'+k+'"><label for="tab_'+k+'"><span>'+k+extname+'</span>: ' + hdulist[k].dim.join('<span style="padding: 1px;">Ã—</span>')+'</label>'
    }
    for (k in hdulist) {
        tabbar.innerHTML += '<ol id="fitshdu_'+k+'"><li>'+hdulist[k].cards.join("\n<li>")+'</ol>'
        tabbingstyle.innerHTML += '#tab_'+k+':checked ~ #fitshdu_'+k+' {display: unset;}\n'
    }
    tab_0.checked = 1
    // color the first 8-char word
    document.querySelectorAll("li").forEach(x => (x.innerHTML = '<span>'+x.innerText.slice(0,8)+'</span>'+x.innerText.slice(8)))
}

async function fitsdata(hdulist, ext=0) {
    hdu = hdulist[ext]
    if (!hdu.hdr.NAXIS) return null
    filename = hdu.file

    var b = {'32': 4, '-32': 4, '-64': 8}[hdu.bitpix]
    var NumberArray = {'32': Int32Array,
                       '-32': Float32Array,
                       '-64': Float64Array}[hdu.bitpix]

    var start = hdu.datastart
    var stop = hdu.dataend

    var headers = {Range: `bytes=${start}-${stop-1}`};
    var response = await fetch(filename, {headers: headers});

    // swap endian
    buf = await response.arrayBuffer()
    d = new NumberArray(new Int8Array(buf.slice()).reverse().buffer).reverse()

    d.dim = hdu.dim
    return d
}


function display(a) {
    if (!a) {console.log('No data to display.'); return}
    var canvas = fitsdisplay;
    var ctx = canvas.getContext("2d");

    [canvas.width, canvas.height] = a.dim;

    // get the imageData and pixel array from the canvas
    var imgData = ctx.getImageData(0,0, ...a.dim);
    var data = imgData.data;

    // put rgba values
    for (var i=0; i<data.length; i+=4) {
        data[i] = 0;
        data[i+3] = 255 - a[i/4]*func.value;   // set opacity
    }

    //ctx.scale(1, -1)
    ctx.putImageData(imgData, 0, 0);
}

disp.onclick = async () => {
    ext = +document.querySelector('[id^="tab"]:checked').id.slice(4);
    await fitsdata(hdulist, ext);
    display(d)
}

// create shared link
document.getElementById("share").onclick = function(e) {
    e.preventDefault()
    _url = new URL(window.location)
    _url = _url.origin + _url.pathname
    args = [url, func].map(x => x.value && x.id+"="+x.value).filter(Boolean)
    ext = document.querySelector("[id^=tab_]:checked").id.slice(4)
    // ext = [... document.querySelectorAll("input[name=exttab]")].findIndex(e=> e.checked)
    if (ext) args.push("ext="+ext)
    if (fitsdisplay.height) args.push("disp")
    var link = document.createElement("a")
    link.href = _url + "?" + args.join("&")
    link.append(link.href)
    info.innerHTML = link.outerHTML
}

func.onchange = e => {display(d)}

url_kwargs = Object.fromEntries(new URL(window.location).searchParams)

for (var key in url_kwargs) {
    elem = document.querySelector("#"+key)
    if (elem) elem.value = url_kwargs[key]
}

doit(url.value).then(async e => {
   if (ext=url_kwargs['ext']) document.querySelector("#tab_"+ext).click()
   if ("disp" in url_kwargs) {
      d = await fitsdata(hdulist, ext=ext||0)
      display(d)
   }
})

</script>

</html>
